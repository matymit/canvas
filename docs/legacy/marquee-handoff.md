# Marquee Selection Handoff Notes (Archive)

> Legacy investigation log retained for historical context. The resolved solution now lives in [Marquee Live Drag Synchronization Fix](../fixes/marquee-live-drag-sync.md).

## Observations

- Transformers now route through `TransformLifecycleCoordinator` with snapshots generated by `TransformController`, but connectors still refuse to move during marquee drags. Snapshot capture can’t reliably find the Konva groups emitted by `ConnectorRenderer`, so connectors stay at 0. Meanwhile mindmap branches rely on store snapshots that never update during drag, so they only reroute at drag end.
- Manual QA (screenshots `Screenshot from 2025-09-29 14-21-13.png`, `14-21-20.png`) shows the marquee picks up connectors but they remain stationary and the transformer disappears on release. Mindmap branches stretch then snap back.
- Docs updated: `docs/architecture/canvas-implementation-progress.md` and `docs/known-issues.md` both flag marquee remains broken and describe next steps.

## Investigations & Findings

- `ConnectorRenderer` creates shapes but they’re not discoverable via `stage.findOne(#id)`; we may need it to set `group.id(conn.id)` or at least a consistent `elementId` on a parent `Konva.Group`.
- Even with point fallbacks, connectors don’t move because we’re not translating the shape/group itself during drag. Without a real node handle the snapshot can’t update visuals.
- Mindmap edges are data-driven. During drag we need to update store positions (e.g. `updateElement(id, { x: base.x + dx, y: base.y + dy })`) or adapt `MindmapRenderer` to consume live Konva positions.

## Next Steps (Historical)

1. Adjust `ConnectorRenderer` to expose a stable Konva group (id or `elementId`) so `captureTransformSnapshot` can pull connectors into `snapshot.connectors`.
2. In `progressSelectionTransform`, once connectors appear in the snapshot, translate the Konva group/line (existing controller logic supports this) and continue rerouting for anchored endpoints.
3. Update mindmap nodes during drag (store updates or renderer integration) so `MindmapController` receives fresh positions and branches follow the marquee live.
4. Optionally pause mindmap live routing during drag to avoid rollback from concurrent reroutes.
5. Re-test marquee with mixed sticky + connector + mindmap selections; expect transform snapshot logs to show `connectors > 0` and connectors to move along with the group.

## Recent Commits

- Refactor selection controllers and expand marquee debug
- Document marquee selection investigation status

Please coordinate with whatever change you make in `ConnectorRenderer` or `MindmapRenderer` to ensure store-driven architecture stays intact, and update docs again once marquee + connectors behave correctly.

## Root Cause

During marquee-drag moves, the canvas’s transform snapshot mechanism isn’t capturing connectors or mindmap edges. The SelectionModule.captureTransformSnapshot only runs when shapes are moved via the Konva Transformer (or programmatic transform); marquee dragging (which uses raw drag events and store actions) doesn’t invoke that snapshot logic. Consequently, connectors aren’t recorded with their geometry, and mindmap branches (which rely on live rerouting) remain static until the drag ends. In practice, connectors “bypass” the transformer (Konva docs confirm line/arrow shapes won’t move with a Transformer
GitHub
), so they never get included in the snapshot unless explicitly handled. Indeed, captureTransformSnapshot() looks up each connector’s Konva Group by id and then its shape via .connector-shape
GitHub
; if the group ID isn’t set or the snapshot isn’t run, the connector is skipped. Similarly, for mindmap nodes the snapshot logic sets pauseLiveRouting=true (see below) and only re-routes edges at drag end, so branches appear frozen during the drag. In short, connectors were never part of the live transform (and lacked explicit IDs in some renderers), and mindmap live-routing was disabled during the move, so their edges did not follow the drag in real-time.

## Solutions (Historical)

To fix this, we must both include connectors in the scene graph and update edges continuously during marquee drags:

- **Render connectors with a Konva Group ID.** The connector renderer must set `group.id = connector.id` (and/or `elementId`) so snapshots can find it. In our code, the `ConnectorRenderer` already does this: it creates a Konva group with `id: conn.id` and `name: "connector"`. Ensuring this is always done (and calling it a transformer-ignored type with `nodeType='connector'`) guarantees the snapshot builder’s `stage.findOne(#${connectorId})` will succeed. If a renderer missed setting the group ID, connectors would be invisible to the snapshot logic.
- **Apply the drag delta to connector shapes during the move.** In the marquee tool’s `progressTransform` handler, translate connectors by the same `(dx, dy)` as the selected elements. One approach is to mirror the `applyConnectorTranslation()` logic from the SelectionModule. For each connector in the snapshot, compute new endpoints by adding the drag delta and update the Konva shapes or the store.
- **Update mindmap branches live during drag.** The mindmap renderer must move nodes and reroute edges on-the-fly. Update the store positions of selected mindmap nodes by the drag delta (so re-renders adjust edges) or call the renderer to redraw connected edges each frame.
- **Control live routing state deliberately.** Snapshot logic disables live routing during transforms to avoid reroute glitches. If applying deltas manually, keep live routing paused; otherwise, briefly re-enable it to allow the renderer to auto-update. Ensure base positions are recaptured to prevent rollback when the drag ends.
- **Reattach the transformer after drag end.** When multiple elements move, the Konva Transformer box can detach. After applying final positions, call `transformerManager.attachToNodes([...])` so the selection frame persists.

## Architectural Notes

These fixes assume the store’s selection and element slices allow updating connector and mindmap-element positions during an ongoing transform (`pushHistory: false` for live moves). The renderer modules (`ConnectorRenderer`, `MindmapRenderer`) already respect Konva node IDs and attributes. By extending the SelectionModule (or MarqueeSelectionTool) to perform these live updates, connectors and mindmap branches visibly move with the drag instead of snapping back at the end.

## Sources

The above summary draws from architecture notes and code references: connector shapes render in a group with `id = connector.id`, and the selection snapshot logic finds those groups by id. The known-issues document noted that connectors “remain transformer-free” and require manual rerouting during marquee moves, which is solved by enabling per-frame updates. Mindmap rerouting was paused in `captureTransformSnapshot` and only done after `transformEnd`; updating during `progressSelectionTransform` keeps the UI aligned with state.