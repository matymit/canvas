<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pan Tool Test</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-step {
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>Pan Tool Functionality Test</h1>

      <div class="test-step">
        <h3>Test Setup</h3>
        <p>
          Testing pan tool functionality on Canvas application at
          http://localhost:1421/
        </p>
      </div>

      <div class="test-step">
        <h3>Step 1: Open Application</h3>
        <p>✓ Application is running at http://localhost:1421/</p>
        <p>✓ Page loads successfully</p>
      </div>

      <div class="test-step">
        <h3>Step 2: Check Pan Tool Implementation</h3>
        <p>
          ✓ PanTool component exists at
          <code
            >src/features/canvas/components/tools/navigation/PanTool.tsx</code
          >
        </p>
        <p>✓ PanTool is properly integrated in FigJamCanvas.tsx on line 622</p>
        <p>✓ Pan tool button exists in toolbar with data-testid="tool-pan"</p>
        <p>✓ Viewport module has setPan method for updating pan position</p>
      </div>

      <div class="test-step">
        <h3>Step 3: Pan Tool Architecture Analysis</h3>
        <p><strong>Implementation Details:</strong></p>
        <ul>
          <li>Uses store-only updates to avoid feedback loops</li>
          <li>FigJamCanvas useEffect handles stage sync from store</li>
          <li>Uses namespaced events to avoid conflicts</li>
          <li>No direct stage manipulation - updates store then syncs</li>
          <li>RAF batching for performance</li>
          <li>Proper cursor management (grab/grabbing)</li>
        </ul>
      </div>

      <div class="test-step">
        <h3>Step 4: Manual Test Instructions</h3>
        <p><strong>To test pan tool manually:</strong></p>
        <ol>
          <li>Open http://localhost:1421/ in your browser</li>
          <li>Look for toolbar with tools (should be visible)</li>
          <li>Find pan tool button (hand icon) - it should have title "Pan"</li>
          <li>Click pan tool button to activate it</li>
          <li>Move your mouse over the canvas area</li>
          <li>Click and drag on the canvas</li>
          <li>Observe if the canvas content moves with your mouse</li>
          <li>Check the browser console for any errors</li>
        </ol>
      </div>

      <div class="test-step">
        <h3>Step 5: Expected Behavior</h3>
        <p><strong>When pan tool is working correctly:</strong></p>
        <ul>
          <li>Cursor should change to "grab" when pan tool is active</li>
          <li>Cursor should change to "grabbing" when dragging</li>
          <li>Canvas content should move smoothly with mouse drag</li>
          <li>No errors should appear in browser console</li>
          <li>Pan should work in any direction (up, down, left, right)</li>
        </ul>
      </div>

      <div class="test-step">
        <h3>Step 6: Troubleshooting</h3>
        <p><strong>If pan tool doesn't work:</strong></p>
        <ul>
          <li>Check browser console for JavaScript errors</li>
          <li>Verify pan tool button is clickable and becomes active</li>
          <li>Check if cursor changes when hovering over canvas</li>
          <li>Verify that viewport.setPan method is being called</li>
          <li>Check if FigJamCanvas viewport sync useEffect is working</li>
        </ul>

        <p><strong>Debugging Steps:</strong></p>
        <ol>
          <li>Open browser DevTools (F12)</li>
          <li>Go to Console tab</li>
          <li>Activate pan tool and try to pan</li>
          <li>
            Look for error messages like:
            <ul>
              <li>"PanTool: viewport.setPan not available"</li>
              <li>"PanTool: Failed to update viewport"</li>
              <li>Any other JavaScript errors</li>
            </ul>
          </li>
          <li>Check Network tab for any failed requests</li>
          <li>Check Elements tab to see if canvas layers exist</li>
        </ol>

        <p><strong>Common Issues Based on Code Analysis:</strong></p>
        <ul>
          <li>
            <strong>Infinite render loop:</strong> FigJamCanvas useEffect had
            dependency issues that were supposedly fixed
          </li>
          <li>
            <strong>Store access issues:</strong> PanTool tries to get
            viewport.setPan from store but it might not be available
          </li>
          <li>
            <strong>Layer sync issues:</strong> FigJamCanvas might not be
            properly syncing viewport changes to Konva layers
          </li>
          <li>
            <strong>Event handling conflicts:</strong> Multiple tools might be
            interfering with pan events
          </li>
        </ul>
      </div>

      <div id="test-results">
        <div class="result info">
          <strong>Test Status:</strong> Code fix implemented - ready for manual
          verification
        </div>
        <div class="result info">
          <strong>FIX IMPLEMENTED:</strong> Viewport subscription fix applied to
          FigJamCanvas.tsx on Sept 24, 2025. Line 67: Changed to subscribe to
          entire viewport object. Line 366: Updated useEffect dependencies to
          use nested viewport properties. Now needs manual testing to verify
          actual functionality.
        </div>
      </div>

      <div class="test-step">
        <h3>Step 7: Implementation Code Review</h3>
        <p><strong>PanTool.tsx key features:</strong></p>
        <pre>
// Event handlers with proper cleanup
stage.on("pointerdown.pantool", handlePointerDown);
stage.on("pointermove.pantool", handlePointerMove);
stage.on("pointerup.pantool", handlePointerUp);

// Store update with RAF batching
rafRef.current = requestAnimationFrame(() => {
  const { viewport } = useUnifiedCanvasStore.getState();
  if (!viewport?.setPan) {
    console.error("PanTool: viewport.setPan not available");
    return;
  }
  const newX = viewport.x + deltaX;
  const newY = viewport.y + deltaY;
  viewport.setPan(newX, newY);
});

// Cursor management
container.style.cursor = "grab";     // When active
container.style.cursor = "grabbing";  // When dragging
            </pre
        >
      </div>

      <div class="test-step">
        <h3>Step 8: Viewport Sync</h3>
        <p><strong>FigJamCanvas.tsx viewport sync:</strong></p>
        <pre>
// Update viewport when store changes
useEffect(() => {
  const stage = stageRef.current;
  if (!stage) return;

  // Apply viewport state directly
  stage.scale({ x: viewport.scale, y: viewport.scale });

  // Apply pan to layers, not stage position
  const { background, main, highlighter, preview, overlay } = layersRef.current;
  if (background) background.position({ x: viewport.x, y: viewport.y });
  if (main) main.position({ x: viewport.x, y: viewport.y });
  if (highlighter) highlighter.position({ x: viewport.x, y: viewport.y });
  if (preview) preview.position({ x: viewport.x, y: viewport.y });
  if (overlay) overlay.position({ x: viewport.x, y: viewport.y });
}, [viewport.scale, viewport.x, viewport.y]);
            </pre
        >
      </div>
    </div>

    <script>
      // Add some basic interactivity for testing
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Pan tool test page loaded");
        console.log(
          "Please test the pan tool manually following the instructions above",
        );
      });
    </script>
  </body>
</html>
